<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <title>Моят профил | Online Test Generator</title>

  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- Твоят собствен CSS -->
  <link
    rel="stylesheet"
    href="css/style.css"
  />
</head>
<body>

<header>
  <h2>Online Test Generator</h2>
</header>

<nav>
  <a id="loginLink" href="login.html">Login</a>
  <a id="registerLink" href="register.html">Register</a>
  <a id="adminLink" href="adminPanel.html" style="display: none;">Admin Panel</a>
  <a id="profileLink" href="profile.html" style="display: none;">Моят акаунт</a>
  <a id="logoutLink" href="/auth/logout" style="display: none;">Изход</a>
</nav>

<div class="container my-4">
  <h1>Моят профил</h1>
  <div id="profile-info" class="mt-3"></div>
</div>

<footer>
  <p>&copy; 2025 OnlineTestGenerator</p>
</footer>

<!-- Bootstrap JS  -->
<script
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
</script>

<script>
  // Остава само JS за профила и аватара!
  window.onload = async function() {
    try {
      const response = await fetch('/auth/status');
      const data = await response.json();
      const user = data.user;

      if (!data.loggedIn) {
        window.location.href = '/login.html';
        return;
      }
      const profileDiv = document.getElementById('profile-info');
      const avatar = user.avatar || '/images/default-avatar.png';

      profileDiv.innerHTML = `
        <form id="avatarForm" enctype="multipart/form-data" class="mt-4">
          <label for="avatar" class="form-label">Промени профилна снимка:</label>
          <input type="file" class="form-control" name="avatar" id="avatar" accept="image/*" required />
          <button type="submit" class="btn btn-primary mt-2">Качи</button>
        </form>
        <div class="card mt-4" style="max-width: 400px;">
          <div class="card-body text-center">
            <img 
              src="${avatar}" 
              alt="Avatar" 
              class="img-fluid rounded-circle mb-3" 
              style="width: 120px; height: 120px; object-fit: cover;"
            />
            <h4 class="card-title">${user.username}</h4>
            <p class="card-text">Роля: <strong>${user.role}</strong></p>
            <div id="role-buttons"></div>
          </div>
        </div>
        `;

      const roleButtons = document.getElementById('role-buttons');
      if (user.role === 'student') {
        roleButtons.innerHTML = `
          <a href="/student-tests.html" class="btn btn-primary mt-2">Моите тестове</a>
        `;
      } else if (user.role === 'teacher' || user.role === 'admin') {
        roleButtons.innerHTML = `
          <a href="/questions.html" class="btn btn-success mt-2">Създай въпрос</a>
          <a href="/tests.html" class="btn btn-primary mt-2">Тестове</a>
        `;
      }

      document.getElementById('avatarForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData();
        const file = document.getElementById('avatar').files[0];
        formData.append('avatar', file);

        const res = await fetch('/auth/upload-avatar', {
          method: 'POST',
          body: formData
        });

        const result = await res.json();
        if (res.ok) {
          alert('Снимката е качена успешно!');
          document.querySelector('img[alt=\"Avatar\"]').src = result.avatar + '?t=' + Date.now();
        } else {
          alert(result.message || 'Грешка при качването');
        }
      });
    } catch (err) {
      console.error('Error loading profile:', err);
    }
  };
</script>

<script src="js/navbar.js"></script>
</body>
</html>
